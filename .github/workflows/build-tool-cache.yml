name: Build and upload tool cache

on:
  workflow_dispatch:
    inputs:
      target-cache:
        description: "Which tool cache to update"
        type: choice
        required: true
        options:
          - test-tool-cache
          - prod-tool-cache

jobs:
  upload_tool_cache:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Clear any existing tool cache
        run: |
          mv "${{ runner.tool_cache }}" "${{ runner.tool_cache }}.old"
          mkdir -p "${{ runner.tool_cache }}"

      - name: Setup Node 12.x
        uses: actions/setup-node@v2
        with:
          node-version: "12.x"

      - name: Setup Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"

      - name: Setup Go 1.19
        uses: actions/setup-go@v2
        with:
          go-version: "1.19"

      - name: Update tool cache for AKS
        uses: azure/cli@v1.0.6
        with:
          inlineScript: |
            az storage file upload-batch \
              --connection-string "${{ secrets.AZURE_CONNECTION_STRING }}" \
              --destination "${{ github.event.inputs.target-cache }}" \
              --source "${{ runner.tool_cache }}"

      - name: Archive tool cache
        run: |
          cd "${{ runner.tool_cache }}"
          tar -czf tool_cache.tgz *

      - name: Upload tool cache artifact for airgapped usage
        uses: actions/upload-artifact@v2
        with:
          name: tool_cache
          path: ${{runner.tool_cache}}/tool_cache.tar.gz
